#!/usr/bin/env ruby
#require 'goliath'
require "goliath/api"
require "goliath/runner"

require "blobsterix"

require "fileutils"

BLOBSTERIX_GEM_DIR = File.join(File.dirname(__FILE__), "../")
BLOBSTERIX_DATA_DIR = Dir.pwd

module ArgParser
  def parse(args)
    args[1..-1].each{|command|
      @param ||= command if command != "generate" and @type
      @type ||= command if command != "generate"
    }
  end
end

class Generator
  include ArgParser
  def initialize(args)
    parse(args)
  end

  def run()
    puts "Doing #{@type} with #{@param} in #{Dir.pwd}"

    init(@param||"") if @type == "init"
    transformation(@param||"NewTrafo") if @type == "transformator"
  end

  def init(folder)
    puts "Init new Blobsterix Server"
    FileUtils.mkdir_p(File.join(BLOBSTERIX_DATA_DIR, folder, "transformators"))

    FileUtils.cp(File.join(BLOBSTERIX_GEM_DIR, "config/Gemfile"), File.join(BLOBSTERIX_DATA_DIR, folder, "Gemfile")) if !File.exist?(File.join(BLOBSTERIX_DATA_DIR, folder, "Gemfile"))
    FileUtils.cp(File.join(BLOBSTERIX_GEM_DIR, "config/blobsterix_config.rb"), File.join(BLOBSTERIX_DATA_DIR, folder, "config.rb")) if !File.exist?(File.join(BLOBSTERIX_DATA_DIR, folder, "config.rb"))
    
  end

  def transformation(name)
    trafo_dir = File.join(BLOBSTERIX_DATA_DIR, "transformators")
    FileUtils.mkdir_p(trafo_dir)
    new_transformator = File.read(File.join(BLOBSTERIX_GEM_DIR, "config/transformation_template.rb"))
    new_transformator = new_transformator.gsub("$ClassName", name.capitalize)
    new_transformator = new_transformator.gsub("$url_name", name.downcase)
    File.write(File.join(trafo_dir, "#{name.downcase}_transformation.rb"), new_transformator)
  end
end
class BlobsterixRunner
  include ArgParser
  def initialize(args)
    parse(args)
  end

  def run_blobsterix()
    require_config()
    require_transformators()

    runner = Goliath::Runner.new(ARGV, nil)

    runner.port = Blobsterix.port if Blobsterix.respond_to?(:port)
    runner.address = Blobsterix.address if Blobsterix.respond_to?(:address)

    Goliath.env = Blobsterix.env if Blobsterix.respond_to?(:env)

    runner.api = Blobsterix::Service.new
    runner.app = Goliath::Rack::Builder.build(Blobsterix::Service, runner.api)

    puts "Now starting Blobsterix #{Blobsterix::VERSION}...."
    runner.run
  end

  private
    def require_config()
      require File.join(BLOBSTERIX_DATA_DIR, "config.rb") if (File.exist?(File.join(BLOBSTERIX_DATA_DIR, "config.rb")))
    end

    def require_transformators()
      trafo_dir = File.join(BLOBSTERIX_DATA_DIR, "transformators")
      return if not File.exist?(trafo_dir)
      Dir.entries(trafo_dir).each{|dir|
        if !File.directory? File.join(trafo_dir,dir) and !(dir =='.' || dir == '..')
          require "#{File.join(trafo_dir,dir)}"
        end
      }
    end
end

puts "Blobsterix #{Blobsterix::VERSION}"
if ARGV.length == 0
  puts "Usage: "
  puts "\tserver (goliath server options) - \n\t\tStarts blobsterix. When a blobsterix config is present in the executing folder it \n\t\twill be used otherwise blobsterix will run with standard options."
  puts "\tgenerate (generator) (param) - Used to generate blobsterix server files"
  puts "\t\t init (foldername) - Creates a new blobsterix project. When a foldername is supplied it will be created in that folder."
  puts "\t\t transformator (TrafoName) - Creates a new blobsterix transformator with the given name or just new as name."
  exit
end
if ARGV[0] == "server"
  BlobsterixRunner.new(ARGV).run_blobsterix
elsif ARGV[0] == "generate"
  Generator.new(ARGV).run
end
